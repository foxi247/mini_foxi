<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jarvis MiniApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <div class="row fade" style="align-items:center; justify-content:space-between;">
      <div>
        <div class="title">Jarvis MiniApp</div>
        <div class="muted">–ñ–∏–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –∑–∞–¥–∞—á–∏</div>
      </div>
      <div id="status-pill" class="pill">–°—Ç–∞—Ç—É—Å: ‚Ä¶</div>
    </div>

    <div class="card fade">
      <div class="row" style="gap:10px;">
        <div class="kpi"><h4>–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</h4><div id="tokens-total">‚Äî</div></div>
        <div class="kpi"><h4>–í—Ö–æ–¥</h4><div id="tokens-in">‚Äî</div></div>
        <div class="kpi"><h4>–í—ã—Ö–æ–¥</h4><div id="tokens-out">‚Äî</div></div>
      </div>
      <div class="muted" style="margin:8px 0 4px;">–ü—Ä–æ–≥–Ω–æ–∑ (—á–∞—Å—ã)</div>
      <div class="bar"><span id="remaining-bar" style="width:50%"></span></div>
      <div id="remaining" class="muted" style="margin-top:4px;">‚Äî</div>
    </div>

    <div class="card fade">
      <div class="progress-block">
        <div class="progress-head">
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –±–æ—Ç–∞</span>
          <span id="bot-progress-val" class="progress-val">‚Äî</span>
        </div>
        <div class="bar" style="margin-top:6px;"><span id="bot-progress" style="width:20%"></span></div>
        <div class="muted" id="bot-progress-note" style="margin-top:4px;">–†–∞–±–æ—Ç–∞–µ–º‚Ä¶</div>
      </div>
    </div>

    <div class="card fade">
      <div class="title" style="font-size:16px;">–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏</div>
      <div id="tasks"></div>
    </div>

    <div class="card fade">
      <div class="title" style="font-size:16px;">–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</div>
      <div class="row board">
        <div class="col board-col"><h4>–ü—Ä–∏–Ω—è–ª</h4><div id="board-todo"></div></div>
        <div class="col board-col"><h4>–í—ã–ø–æ–ª–Ω—è—é</h4><div id="board-doing"></div></div>
        <div class="col board-col"><h4>–ì–æ—Ç–æ–≤–æ</h4><div id="board-done"></div></div>
      </div>
    </div>

    <div class="card fade">
      <div class="title" style="font-size:16px;">–õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</div>
      <div id="events"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-btn" onclick="scrollToSection('tasks')"><span>üóÇ</span>–ó–∞–¥–∞—á–∏</div>
    <div class="nav-btn" onclick="scrollToSection('board-todo')"><span>üìå</span>–î–æ—Å–∫–∞</div>
    <div class="nav-btn" onclick="scrollToSection('events')"><span>‚ö°</span>–°–æ–±—ã—Ç–∏—è</div>
    <div class="nav-btn" onclick="scrollToSection('bot-progress')"><span>ü§ñ</span>–ë–æ—Ç</div>
  </div>

<script>
const API = 'http://localhost:3001/api/v1/metrics'; // –ø–æ–º–µ–Ω—è–π –Ω–∞ gateway JSON, –µ—Å–ª–∏ –Ω–∞–π–¥—ë—à—å —ç–Ω–¥–ø–æ–∏–Ω—Ç
const tTotal = document.getElementById('tokens-total');
const tIn = document.getElementById('tokens-in');
const tOut = document.getElementById('tokens-out');
const tRem = document.getElementById('remaining');
const tBar = document.getElementById('remaining-bar');
const tasksBox = document.getElementById('tasks');
const eventsBox = document.getElementById('events');
const statusPill = document.getElementById('status-pill');
const botProg = document.getElementById('bot-progress');
const botProgVal = document.getElementById('bot-progress-val');
const botProgNote = document.getElementById('bot-progress-note');
const boardCols = {
  todo: document.getElementById('board-todo'),
  doing: document.getElementById('board-doing'),
  done: document.getElementById('board-done'),
};

function setText(el, txt) { el.textContent = txt; }

function renderTokens(data) {
  const tokens = data.tokens || {}; 
  const total = (tokens.input||0) + (tokens.output||0);
  setText(tTotal, total ? total.toLocaleString('ru-RU') : '‚Äî');
  setText(tIn, tokens.input ? tokens.input.toLocaleString('ru-RU') : '‚Äî');
  setText(tOut, tokens.output ? tokens.output.toLocaleString('ru-RU') : '‚Äî');
  const rem = tokens.remainingHours ?? 0;
  setText(tRem, rem ? rem.toFixed(1) + ' —á' : '‚Äî');
  const pct = Math.max(5, Math.min(100, (rem/12)*100 || 5));
  tBar.style.width = pct + '%';
}

function renderStatus(data) {
  const online = data.server?.online;
  statusPill.classList.toggle('online', !!online);
  statusPill.classList.toggle('offline', !online);
  statusPill.textContent = online ? '–°—Ç–∞—Ç—É—Å: online' : '–°—Ç–∞—Ç—É—Å: offline';
  tasksBox.innerHTML = '';
  const list = data.server?.tasks || [];
  if (!list.length) tasksBox.innerHTML = '<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
  list.forEach(t => {
    const el = document.createElement('div');
    el.className = 'item fade';
    el.textContent = t;
    tasksBox.appendChild(el);
  });
}

function renderBoard(data) {
  const board = data.board || {todo:[],doing:[],done:[]};
  ['todo','doing','done'].forEach(k => {
    const box = boardCols[k];
    box.innerHTML = '';
    if (!board[k]?.length) { box.innerHTML = '<div class="muted">–ü—É—Å—Ç–æ</div>'; return; }
    board[k].forEach(item => {
      const el = document.createElement('div');
      el.className = 'item fade';
      el.textContent = item;
      box.appendChild(el);
    });
  });
}

function renderEvents(data) {
  eventsBox.innerHTML = '';
  const ev = data.server?.events || [];
  if (!ev.length) { eventsBox.innerHTML = '<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>'; return; }
  ev.forEach(e => {
    const el = document.createElement('div');
    el.className = 'event fade';
    el.textContent = e;
    eventsBox.appendChild(el);
  });
}

function renderBotProgress(data) {
  const p = data.botProgress?.percent ?? 40;
  botProg.style.width = Math.max(5, Math.min(100, p)) + '%';
  botProgVal.textContent = Math.round(p) + '%';
  botProgNote.textContent = data.botProgress?.note || '–†–∞–±–æ—Ç–∞—é –Ω–∞–¥ –∑–∞–¥–∞—á–∞–º–∏';
}

async function fetchData() {
  try {
    const res = await fetch(API);
    if (!res.ok) throw new Error('bad status');
    return await res.json();
  } catch (e) {
    return null;
  }
}

async function refresh() {
  const data = await fetchData();
  if (!data) return;
  renderTokens(data);
  renderStatus(data);
  renderBoard(data);
  renderEvents(data);
  renderBotProgress(data);
}

function scrollToSection(id) {
  const el = document.getElementById(id);
  if (el) el.scrollIntoView({behavior:'smooth'});
}

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
